<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Korsekode — TK22 SG PRO (Course)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280;
      --brand:#0f172a; --accent:#4353ff; --accent-2:#111827;
      --border:#e6e8ef; --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08);
      --good:#10b981; --bad:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    header{position:sticky; top:0; z-index:40; background:var(--brand); color:#fff; padding:14px 16px}
    header h1{margin:0; font-size:16px;}
    .container{max-width:980px; margin:0 auto; padding:12px 12px 180px}
    section{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); margin:12px 0; padding:14px}
    h2{font-size:16px; margin:4px 0 12px}
    label{display:block; font-size:12px; color:#374151; margin:6px 0 6px}
    input,select,button,textarea{width:100%; padding:12px; border-radius:12px; border:1px solid #d7d9e0; font-size:14px;}
    input:focus,select:focus,textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(67,83,255,.15)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    .row4{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    .btn{background:var(--accent-2); color:#fff; border:none; cursor:pointer; font-weight:600}
    .btn.secondary{background:var(--accent)}
    .btn.ghost{background:#f8fafc; color:#111; border:1px solid var(--border)}
    .btn.success{background:var(--good)}
    .btn.warn{background:var(--warn); color:#111}
    .small{font-size:12px; color:var(--muted)}
    .sticky-footer{position:fixed; bottom:0; left:0; right:0; background:#fff; border-top:1px solid var(--border); padding:12px; display:flex; gap:8px; box-shadow:0 -8px 24px rgba(0,0,0,.06);}
  </style>
</head>
<body>
<header>
  <h1>TK22 — Korsekode (Course)</h1>
</header>
<div class="container" id="appRoot">
  <!-- 라운드 생성 -->
  <section id="round">
    <h2>라운드 생성 <span class="small" style="margin-left:8px; color:#6b7280;">Quick Start 지원</span></h2>
    <div class="row">
      <div>
        <label>Player ID</label>
        <input id="inpPlayer" placeholder=""/>
      </div>
      <div>
        <label>Course</label>
        <input id="inpCourse" placeholder=""/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Round Type</label>
        <select id="ddType">
          <option value="practice">Practice</option>
          <option value="tournament">Tournament</option>
        </select>
      </div>
      <div>
        <label>Par 배열(18홀, 쉼표로 구분)</label>
        <input id="inpParArray" placeholder=""/>
      </div>
    </div>
    <div class="row">
      <div><button class="btn" id="btnCreateRound">라운드 생성</button></div>
      <div class="row" style="gap:8px">
        <button class="btn ghost" id="btnQuick">빠른 시작</button>
        <button class="btn ghost" id="btnExport">내보내기(JSON)</button>
      </div>
    </div>
    <div class="row">
      <div><button class="btn ghost" id="btnImport">가져오기(JSON)</button></div>
      <div><input type="file" id="fileImport" accept="application/json"/></div>
    </div>
    <div class="small" id="logRound">-</div>
  </section>

  <!-- 샷 입력 -->
  <section id="shot">
    <h2>샷 입력</h2>
    <div class="row4" style="margin:-6px 0 6px">
      <button class="btn ghost" data-phase="tee">티샷</button>
      <button class="btn ghost" data-phase="approach">파온 시도</button>
      <button class="btn ghost" data-phase="around">30m 이내</button>
      <button class="btn ghost" data-phase="putt">퍼팅</button>
    </div>

    <div class="row3">
      <div>
        <label>Hole</label>
        <select id="ddHole"></select>
      </div>
      <div>
        <label>Phase</label>
        <select id="ddPhase">
          <option value="tee">티샷</option>
          <option value="approach">파온 시도(중간샷)</option>
          <option value="around">30m 이내 어프로치</option>
          <option value="putt">그린(퍼팅)</option>
        </select>
      </div>
      <div>
        <label>Sequence</label>
        <input id="inpSeq" type="number" value="1"/>
      </div>
    </div>

    <div class="row3">
      <div>
        <label>현재 남은거리 (m)</label>
        <input id="inpDistanceM" type="number" placeholder=""/>
      </div>
      <div>
        <label>다음 남은거리 (m)</label>
        <input id="inpRemainM" type="number" placeholder=""/>
      </div>
      <div>
        <label>Penalty (벌타)</label>
        <input id="inpPenalty" type="number" value="0"/>
      </div>
    </div>

    <div class="row3">
      <div>
        <label>Club</label>
        <select id="ddClub"></select>
      </div>
      <div>
        <label>Aim</label>
        <select id="ddAim"></select>
      </div>
      <div>
        <label>Lie/State</label>
        <select id="ddLie"></select>
      </div>
    </div>

    <div class="row3">
      <div>
        <label>Landing (m)</label>
        <input id="inpLandingM" type="number" placeholder=""/>
      </div>
      <div>
        <label>Landing→Pin (m)</label>
        <input id="inpLandingToPinM" type="number" placeholder=""/>
      </div>
      <div>
        <label>On Green?</label>
        <select id="ddOnGreen">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </div>
    </div>

    <div class="row3">
      <div>
        <label>Pin Pos</label>
        <select id="ddPinPos"></select>
      </div>
      <div>
        <label>Break</label>
        <select id="ddBreak">
          <option value="">-</option>
          <option value="LtoR">L to R</option>
          <option value="RtoL">R to L</option>
        </select>
      </div>
      <div>
        <label>Slope</label>
        <select id="ddSlope">
          <option value="">-</option>
          <option value="Up">Up</option>
          <option value="Dw">Dw</option>
        </select>
      </div>
    </div>

    <div class="row3">
      <div>
        <label>Miss (퍼팅 미스 방향)</label>
        <select id="ddMiss">
          <option value="">-</option>
          <option value="short">short</option>
          <option value="long">long</option>
          <option value="low">low</option>
          <option value="high">high</option>
        </select>
      </div>
      <div>
        <label>Holed?</label>
        <select id="ddHoled">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </div>
      <div>
        <label>Wind (바람)</label>
        <select id="ddWind">
          <option value="">-</option>
          <option value="앞">앞바람</option>
          <option value="뒤">뒷바람</option>
          <option value="없음">없음</option>
          <option value="슬라이스">슬라이스 바람</option>
          <option value="훅">훅 바람</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <button class="btn secondary" id="btnAddShot">샷 추가</button>
      <button class="btn ghost" id="btnEndHole">홀 종료 / 다음 홀</button>
    </div>

    <div class="small" id="logShot">-</div>

    <div style="margin-top:10px; overflow:auto;">
      <table id="tblShots">
        <thead>
          <tr>
            <th>Hole</th><th>Seq</th><th>Phase</th><th>Dist(now)</th><th>Remain(next)</th>
            <th>Club</th><th>Aim</th><th>Lie</th><th>OnG</th><th>Holed</th><th>Penalty</th><th>Wind</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
  <!-- 분석 / 요약 -->
  <section id="analyze">
    <h2>분석 / 요약</h2>

    <div class="row">
      <div>
        <label>Filter</label>
        <select id="ddFilter">
          <option value="all">All</option>
          <option value="practice">Practice</option>
          <option value="tournament">Tournament</option>
          <option value="last5">최근 5경기</option>
          <option value="last10">최근 10경기</option>
        </select>
      </div>
      <div style="align-self:end; text-align:right;">
        <button class="btn" id="btnRecalc">요약 재계산</button>
      </div>
    </div>

    <!-- SG 카드 -->
    <div class="row3" style="margin-top:8px;">
      <div class="kcard">
        <div class="pill">SG OTT</div>
        <div id="sgOtt" class="mono">0.00</div>
      </div>
      <div class="kcard">
        <div class="pill">SG APP</div>
        <div id="sgApp" class="mono">0.00</div>
      </div>
      <div class="kcard">
        <div class="pill">SG ARG</div>
        <div id="sgArg" class="mono">0.00</div>
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <div class="kcard">
        <div class="pill">SG PUT</div>
        <div id="sgPut" class="mono">0.00</div>
      </div>
      <div class="kcard">
        <div class="pill">SG TOTAL</div>
        <div id="sgTotal" class="mono">0.00</div>
      </div>
    </div>

    <div class="row" style="margin-top:6px;">
      <div class="kcard">
        <div class="pill">FIR / GIR</div>
        <div class="mono">
          <span id="firPct">0.0%</span> / <span id="girPct">0.0%</span>
        </div>
        <div class="small mono" style="margin-top:6px;">
          FW(all): <span id="fwAnyPct">0.0%</span> &nbsp;|&nbsp;
          FW(APP): <span id="fwAppPct">0.0%</span>
        </div>
      </div>
      <div class="kcard">
        <div class="pill">FIR 위치 분해(LF/CF/RF)</div>
        <div class="mono">
          LF: <span id="firLFPct">0.0%</span> &nbsp;|&nbsp;
          CF: <span id="firCFPct">0.0%</span> &nbsp;|&nbsp;
          RF: <span id="firRFPct">0.0%</span>
        </div>
        <div class="small" style="margin-top:6px;">
          * 티샷 결과 + 세컨 라이 추정 보강 포함
        </div>
      </div>
    </div>

    <h2 style="margin-top:16px;">아이언(어프로치) 거리별 GIR + FIR (총합/위치별)</h2>
    <div class="small">거리 버킷 기준: <span id="ironBucketInfo" class="mono">0–50, 50–100, 100–150, 150–200, 200+</span></div>
    <div style="overflow:auto; margin-top:8px;">
      <table id="tblIronGIRFIR">
        <thead>
          <tr>
            <th>거리대</th>
            <th>시도(APP)</th>
            <th>GIR</th>
            <th>GIR %</th>
            <th>FIR(Total)</th>
            <th>FIR-LF</th>
            <th>FIR-CF</th>
            <th>FIR-RF</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2 style="margin-top:16px;">클럽/거리별 GIR</h2>
    <div style="overflow:auto;">
      <table id="tblGIRClubDist">
        <thead>
          <tr>
            <th>클럽</th><th>거리대</th><th>시도</th><th>성공</th><th>확률 %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2 style="margin-top:16px;">퍼팅 결과 확률</h2>
    <div style="overflow:auto;">
      <table id="tblPuttProbs">
        <thead>
          <tr>
            <th>거리대</th><th>시도</th><th>성공</th><th>성공률 %</th><th>short</th><th>long</th><th>low</th><th>high</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2 style="margin-top:16px;">퍼팅 라이/브레이크별 성공률</h2>
    <div class="small">Up/Dw(경사) + LtoR/RtoL(브레이크) 조합</div>
    <div style="overflow:auto; margin-top:8px;">
      <table id="tblPuttSlope">
        <thead>
          <tr>
            <th>카테고리</th><th>시도</th><th>성공</th><th>성공률 %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2 style="margin-top:16px;">바람 영향(요약)</h2>
    <div class="small">* 샷별 입력된 바람 데이터를 바탕으로 APP/ARG/PUT 지표를 분해합니다.</div>
    <div style="overflow:auto; margin-top:8px;">
      <table id="tblWindSummary">
        <thead>
          <tr>
            <th>바람</th><th>시도</th><th>SG/샷</th><th>GIR %</th><th>퍼팅성공 %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="small" id="logAnalyze">-</div>
  </section>

  <!-- ✅ 스코어카드 -->
  <section id="scorecard">
    <div class="score-head" style="display:flex; align-items:center; justify-content:space-between; gap:8px">
      <h2>스코어카드 (홀 종료 시 자동 갱신)</h2>
      <div class="small">표시값: <span class="chip ok">FIR</span> <span class="chip ok">GIR</span> <span class="chip">Putts</span></div>
    </div>
    <div class="score-grid" style="margin-top:8px; overflow:auto">
      <table id="tblScore">
        <thead>
          <tr>
            <th>Hole</th>
            <th>Par</th>
            <th>Score</th>
            <th>±</th>
            <th>FIR</th>
            <th>GIR</th>
            <th>Putts</th>
          </tr>
        </thead>
        <tbody id="scoreBody"></tbody>
      </table>
    </div>
    <div class="small" id="logScore">-</div>
  </section>
  <!-- Footer -->
  <div class="sticky-footer">
    <button class="btn" id="btnSaveLocal">로컬 저장</button>
    <button class="btn" id="btnRoundComplete">라운드 완료 (크로니컬 열기)</button>
    <button class="btn ghost" id="btnClearLocal">로컬 초기화</button>
  </div>
</div> <!-- /container -->

<!-- ================== SCRIPT ================== -->
<script>
(function(){
  // 데이터 저장소
  let rounds=[], shots=[];
  let currentRoundId=null;

  // 허용된 Player ID
  const ALLOWED_PLAYERS=new Set(["224252","224224","224073"]);

  // ─────────────── 유틸 ───────────────
  function $(sel){return document.querySelector(sel)}
  function nowId(){return 'id'+Date.now()}
  function saveLocal(){
    localStorage.setItem("kdk:rounds",JSON.stringify(rounds));
    localStorage.setItem("kdk:shots",JSON.stringify(shots));
  }
  function loadLocal(){
    try{
      rounds=JSON.parse(localStorage.getItem("kdk:rounds")||"[]");
      shots=JSON.parse(localStorage.getItem("kdk:shots")||"[]");
    }catch(e){rounds=[]; shots=[];}
  }

  // ─────────────── 라운드 생성 ───────────────
  function guardAllowed(pidRaw){
    const pid=String(pidRaw||"").trim();
    if(!pid){throw new Error("PLAYER_ID_REQUIRED")}
    if(!ALLOWED_PLAYERS.has(pid)){throw new Error("PLAYER_NOT_ALLOWED")}
    return pid;
  }

  function createRound(){
    let rawPlayer=$('#inpPlayer').value;
    let pid;
    try{ pid=guardAllowed(rawPlayer); }
    catch(err){
      if(err.message==="PLAYER_NOT_ALLOWED"){alert("허용되지 않은 Player ID 입니다.");return;}
      if(err.message==="PLAYER_ID_REQUIRED"){alert("Player ID 필요");return;}
      throw err;
    }
    const course=$('#inpCourse').value;
    const type=$('#ddType').value;
    const parStr=$('#inpParArray').value.trim()||'4,4,3,4,5,4,3,5,4,4,4,3,4,5,4,3,5,4';
    const parArray=parStr.split(',').map(s=>Number(s.trim())||4).slice(0,18);
    while(parArray.length<18) parArray.push(4);

    const round={roundId:nowId(),playerId:pid,date:new Date().toISOString(),course,type,parArray,notes:''};
    rounds.push(round);
    currentRoundId=round.roundId;
    $('#logRound').textContent=`라운드 생성: ${currentRoundId}`;
    saveLocal();
  }

  // ─────────────── 샷 추가 ───────────────
  function addShot(){
    if(!currentRoundId){alert("라운드 먼저 생성하세요");return;}
    const s={
      roundId:currentRoundId,
      hole:Number($('#ddHole').value),
      sequence:Number($('#inpSeq').value),
      phase:$('#ddPhase').value,
      distance_m:Number($('#inpDistanceM').value)||0,
      remaining_m:Number($('#inpRemainM').value)||0,
      club:$('#ddClub').value,
      aim:$('#ddAim').value,
      lie:$('#ddLie').value,
      on_green:($('#ddOnGreen').value==="true"),
      holed:($('#ddHoled').value==="true"),
      penalty:Number($('#inpPenalty').value)||0,
      landing_m:Number($('#inpLandingM').value)||0,
      landing_to_pin_m:Number($('#inpLandingToPinM').value)||0,
      pin_pos:$('#ddPinPos').value,
      break:$('#ddBreak').value,
      slope:$('#ddSlope').value,
      miss:$('#ddMiss').value,
      wind:$('#ddWind').value
    };
    shots.push(s);
    saveLocal();
    $('#logShot').textContent=`샷 추가: Hole ${s.hole} Seq ${s.sequence}`;
    renderShots();
  }

  function renderShots(){
    const tb=$('#tblShots tbody');
    tb.innerHTML='';
    shots.filter(s=>s.roundId===currentRoundId).forEach(s=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${s.hole}</td><td>${s.sequence}</td><td>${s.phase}</td>
      <td>${s.distance_m}</td><td>${s.remaining_m}</td><td>${s.club}</td>
      <td>${s.aim}</td><td>${s.lie}</td><td>${s.on_green}</td>
      <td>${s.holed}</td><td>${s.penalty}</td><td>${s.wind}</td>`;
      tb.appendChild(tr);
    });
  }

  // ─────────────── 크로니컬 연동 ───────────────
  async function handleRoundComplete(){
    if(!currentRoundId){alert("라운드가 없습니다");return;}
    const curr=rounds.find(r=>r.roundId===currentRoundId);
    try{
      const pid=guardAllowed(curr.playerId);
      const payload={schema_version:"kdk-1.0.0",playerId:pid,rounds,shots};
      localStorage.setItem("kdk:lastExport",JSON.stringify(payload));
      const KHR="https://jjkim-png.github.io/khroniclev3/?autoload=1";
      window.open(KHR,"_blank");
    }catch(err){
      if(err.message==="PLAYER_NOT_ALLOWED") alert("허용되지 않은 Player ID");
      else alert("오류 발생");
    }
  }

  // ─────────────── 이벤트 바인딩 ───────────────
  function init(){
    loadLocal();
    document.getElementById('btnCreateRound').onclick=createRound;
    document.getElementById('btnAddShot').onclick=addShot;
    document.getElementById('btnRoundComplete').onclick=handleRoundComplete;
    document.getElementById('btnSaveLocal').onclick=saveLocal;
    document.getElementById('btnClearLocal').onclick=function(){
      localStorage.clear(); rounds=[]; shots=[]; alert("초기화 완료");
    };
  }
  init();
})();
</script>
</body>
</html>
