<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Korsekode — TK22 SG PRO (Course)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280;
      --brand:#0f172a; --accent:#4353ff; --accent-2:#111827;
      --border:#e6e8ef; --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08);
      --good:#10b981; --bad:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    header{position:sticky; top:0; z-index:40; background:var(--brand); color:#fff; padding:14px 16px}
    header h1{margin:0; font-size:16px;}
    .container{max-width:980px; margin:0 auto; padding:12px 12px 180px}
    section{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); margin:12px 0; padding:14px}
    h2{font-size:16px; margin:4px 0 12px}
    label{display:block; font-size:12px; color:#374151; margin:6px 0 6px}
    input,select,button,textarea{width:100%; padding:12px; border-radius:12px; border:1px solid #d7d9e0; font-size:14px;}
    input:focus,select:focus,textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(67,83,255,.15)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    .row4{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    .btn{background:var(--accent-2); color:#fff; border:none; cursor:pointer; font-weight:600}
    .btn.secondary{background:var(--accent)}
    .btn.ghost{background:#f8fafc; color:#111; border:1px solid var(--border)}
    .btn.success{background:var(--good)}
    .btn.warn{background:var(--warn); color:#111}
    .small{font-size:12px; color:var(--muted)}
    .sticky-footer{position:fixed; bottom:0; left:0; right:0; background:#fff; border-top:1px solid var(--border); padding:12px; display:flex; gap:8px; box-shadow:0 -8px 24px rgba(0,0,0,.06);}
  </style>
</head>
<body>
<header>
  <h1>TK22 — Korsekode (Course)</h1>
</header>
<div class="container" id="appRoot">
  <!-- 라운드 생성 -->
  <section id="round">
    <h2>라운드 생성 <span class="small" style="margin-left:8px; color:#6b7280;">Quick Start 지원</span></h2>
    <div class="row">
      <div>
        <label>Player ID</label>
        <input id="inpPlayer" placeholder=""/>
      </div>
      <div>
        <label>Course</label>
        <input id="inpCourse" placeholder=""/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Round Type</label>
        <select id="ddType">
          <option value="practice">Practice</option>
          <option value="tournament">Tournament</option>
        </select>
      </div>
      <div>
        <label>Par 배열(18홀, 쉼표로 구분)</label>
        <input id="inpParArray" placeholder=""/>
      </div>
    </div>
    <div class="row">
      <div><button class="btn" id="btnCreateRound">라운드 생성</button></div>
      <div class="row" style="gap:8px">
        <button class="btn ghost" id="btnQuick">빠른 시작</button>
        <button class="btn ghost" id="btnExport">내보내기(JSON)</button>
      </div>
    </div>
    <div class="row">
      <div><button class="btn ghost" id="btnImport">가져오기(JSON)</button></div>
      <div><input type="file" id="fileImport" accept="application/json"/></div>
    </div>
    <div class="small" id="logRound">-</div>
  </section>

  <!-- 샷 입력 -->
  <section id="shot">
    <h2>샷 입력</h2>
    <div class="row4" style="margin:-6px 0 6px">
      <button class="btn ghost" data-phase="tee">티샷</button>
      <button class="btn ghost" data-phase="approach">파온 시도</button>
      <button class="btn ghost" data-phase="around">30m 이내</button>
      <button class="btn ghost" data-phase="putt">퍼팅</button>
    </div>

    <div class="row3">
      <div>
        <label>Hole</label>
        <select id="ddHole"></select>
      </div>
      <div>
        <label>Phase</label>
        <select id="ddPhase">
          <option value="tee">티샷</option>
          <option value="approach">파온 시도(중간샷)</option>
          <option value="around">30m 이내 어프로치</option>
          <option value="putt">그린(퍼팅)</option>
        </select>
      </div>
      <div>
        <label>Sequence</label>
        <input id="inpSeq" type="number" value="1"/>
      </div>
    </div>

    <div class="row3">
      <div>
        <label>현재 남은거리 (m)</label>
        <input id="inpDistanceM" type="number" placeholder=""/>
      </div>
      <div>
        <label>다음 남은거리 (m)</label>
        <input id="inpRemainM" type="number" placeholder=""/>
      </div>
      <div>
        <label>Penalty (벌타)</label>
        <input id="inpPenalty" type="number" value="0"/>
      </div>
    </div>

    <div class="row3">
      <div>
        <label>Club</label>
        <select id="ddClub"></select>
      </div>
      <div>
        <label>Aim</label>
        <select id="ddAim"></select>
      </div>
      <div>
        <label>Lie/State</label>
        <select id="ddLie"></select>
      </div>
    </div>

    <div class="row3">
      <div>
        <label>Landing (m)</label>
        <input id="inpLandingM" type="number" placeholder=""/>
      </div>
      <div>
        <label>Landing→Pin (m)</label>
        <input id="inpLandingToPinM" type="number" placeholder=""/>
      </div>
      <div>
        <label>On Green?</label>
        <select id="ddOnGreen">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </div>
    </div>

    <div class="row3">
      <div>
        <label>Pin Pos</label>
        <select id="ddPinPos"></select>
      </div>
      <div>
        <label>Break</label>
        <select id="ddBreak">
          <option value="">-</option>
          <option value="LtoR">L to R</option>
          <option value="RtoL">R to L</option>
        </select>
      </div>
      <div>
        <label>Slope</label>
        <select id="ddSlope">
          <option value="">-</option>
          <option value="Up">Up</option>
          <option value="Dw">Dw</option>
        </select>
      </div>
    </div>

    <div class="row3">
      <div>
        <label>Miss (퍼팅 미스 방향)</label>
        <select id="ddMiss">
          <option value="">-</option>
          <option value="short">short</option>
          <option value="long">long</option>
          <option value="low">low</option>
          <option value="high">high</option>
        </select>
      </div>
      <div>
        <label>Holed?</label>
        <select id="ddHoled">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </div>
      <div>
        <label>Wind (바람)</label>
        <select id="ddWind">
          <option value="">-</option>
          <option value="앞">앞바람</option>
          <option value="뒤">뒷바람</option>
          <option value="없음">없음</option>
          <option value="슬라이스">슬라이스 바람</option>
          <option value="훅">훅 바람</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <button class="btn secondary" id="btnAddShot">샷 추가</button>
      <button class="btn ghost" id="btnEndHole">홀 종료 / 다음 홀</button>
    </div>

    <div class="small" id="logShot">-</div>

    <div style="margin-top:10px; overflow:auto;">
      <table id="tblShots">
        <thead>
          <tr>
            <th>Hole</th><th>Seq</th><th>Phase</th><th>Dist(now)</th><th>Remain(next)</th>
            <th>Club</th><th>Aim</th><th>Lie</th><th>OnG</th><th>Holed</th><th>Penalty</th><th>Wind</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
<script>
// ─────────────── 허용 Player ID 체크 ───────────────
const ALLOWED_PLAYERS = new Set(["224252","224224","224073"]);
function guardAllowed(pidRaw){
  const pid = String(pidRaw||"").trim();
  if (!pid) throw new Error("PLAYER_ID_REQUIRED");
  if (!ALLOWED_PLAYERS.has(pid)) throw new Error("PLAYER_NOT_ALLOWED");
  return pid;
}

// ─────────────── 크로니컬 연동 ───────────────
async function handleRoundComplete(){
  try {
    const rounds = JSON.parse(localStorage.getItem("tk22_rounds")||"[]");
    const shots  = JSON.parse(localStorage.getItem("tk22_shots")||"[]");
    if (!rounds.length) { alert("라운드 데이터가 없습니다."); return; }

    const lastRound = rounds[rounds.length-1];
    const pid = guardAllowed(lastRound.playerId);

    const payload = {
      schema_version:"kdk-1.0.0",
      playerId: pid,
      rounds, shots
    };
    localStorage.setItem("kdk:lastExport", JSON.stringify(payload));
    window.open("https://jjkim-png.github.io/khroniclev3/?autoload=1","_blank");
  } catch(err){
    if(err.message==="PLAYER_NOT_ALLOWED"){
      alert("허용되지 않은 Player ID 입니다. (224252/224224/224073)");
    } else if(err.message==="PLAYER_ID_REQUIRED"){
      alert("Player ID를 입력하세요.");
    } else {
      console.error(err);
      alert("라운드 완료 처리 중 오류가 발생했습니다.");
    }
  }
}

// ─────────────── 버튼 가드/바인딩 ───────────────
window.addEventListener("DOMContentLoaded", () => {
  // 라운드 생성 버튼 보호(원본 createRound 호출 전 차단 — 비침투)
  const btnCreate = document.getElementById("btnCreateRound");
  if (btnCreate) {
    btnCreate.addEventListener("click",(e)=>{
      const pidInput = (document.getElementById("inpPlayer")?.value)||"";
      try { guardAllowed(pidInput); }
      catch(err){
        e.preventDefault(); e.stopPropagation();
        alert("허용되지 않은 Player ID 입니다. (224252/224224/224073)");
      }
    }, true); // capture: 원본 리스너보다 먼저 실행
  }

  // 라운드 완료 → 크로니컬 전송
  const btnDone = document.getElementById("btnRoundComplete");
  if (btnDone) btnDone.addEventListener("click", handleRoundComplete);
});
</script>
</body>
</html>
